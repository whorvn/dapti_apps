<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Students</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/datatables.min.css') }}">
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="{{ url_for('index') }}">Student Analysis</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('index') }}">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('analyze') }}">Analysis</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{{ url_for('compare_students') }}">Compare</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h2 class="card-title mb-0">Compare Students</h2>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('compare_students') }}" method="post">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h5 class="card-title mb-0">Select Students</h5>
                                        </div>
                                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                            {% for student in students %}
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="students" value="{{ student }}" 
                                                    id="student{{ loop.index }}" 
                                                    {% if selected_students and student in selected_students %}checked{% endif %}>
                                                <label class="form-check-label" for="student{{ loop.index }}">
                                                    {{ student }}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h5 class="card-title mb-0">Comparison Options</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="compare_by" class="form-label">Compare by:</label>
                                                <select class="form-select" id="compare_by" name="compare_by">
                                                    <option value="Success Rate" {% if compare_by == "Success Rate" %}selected{% endif %}>
                                                        Success Rate
                                                    </option>
                                                    <option value="Tasks Completed" {% if compare_by == "Tasks Completed" %}selected{% endif %}>
                                                        Tasks Completed
                                                    </option>
                                                    <option value="Days Worked" {% if compare_by == "Days Worked" %}selected{% endif %}>
                                                        Days Worked
                                                    </option>
                                                    <option value="Max Streak" {% if compare_by == "Max Streak" %}selected{% endif %}>
                                                        Max Streak
                                                    </option>
                                                    <option value="Diagnostics" {% if compare_by == "Diagnostics" %}selected{% endif %}>
                                                        Diagnostics
                                                    </option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="subject" class="form-label">Subject:</label>
                                                <select class="form-select" id="subject" name="subject">
                                                    {% for subject_option in available_subjects %}
                                                    <option value="{{ subject_option }}" {% if subject == subject_option %}selected{% endif %}>
                                                        {{ subject_option }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary">Compare</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {% if comparison_data %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h3 class="card-title">Comparison Results</h3>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="comparisonTabs">
                            <li class="nav-item">
                                <a class="nav-link active" id="chart-tab" data-bs-toggle="tab" href="#chartView">Chart</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="table-tab" data-bs-toggle="tab" href="#tableView">Table</a>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3">
                            <div class="tab-pane fade show active" id="chartView">
                                <div id="comparisonChart" style="height: 500px;"></div>
                            </div>
                            <div class="tab-pane fade" id="tableView">
                                <div class="table-responsive">
                                    <table id="comparisonTable" class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Student</th>
                                                <th>{{ compare_by }}</th>
                                                {% if subject == "All" %}
                                                <th>Subjects</th>
                                                {% endif %}
                                                <th>Grade</th>
                                                <th>Days Worked</th>
                                                <th>Total Tasks</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for student in comparison_data %}
                                            <tr>
                                                <td>
                                                    <a href="{{ url_for('student_details', student_name=student.name|replace(' ', '_')) }}">
                                                        {{ student.name }}
                                                    </a>
                                                </td>
                                                <td>{{ student.value }}{% if compare_by == "Success Rate" %}%{% endif %}</td>
                                                {% if subject == "All" %}
                                                <td>{{ student.subjects }}</td>
                                                {% endif %}
                                                <td>{{ student.grade }}</td>
                                                <td>{{ student.days_worked }}</td>
                                                <td>{{ student.total_tasks }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <footer class="mt-5 text-center text-muted">
            <p>&copy; 2023 Student Task Analysis System</p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/datatables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/plotly-latest.min.js') }}"></script>

    <script>
        $(document).ready(function() {
            {% if comparison_data %}
            // Initialize DataTable
            $('#comparisonTable').DataTable({
                order: [[1, 'desc']]
            });
            
            // Create comparison chart
            const comparisonChart = document.getElementById('comparisonChart');
            
            const chartData = [
                {
                    y: [{% for student in comparison_data %}'{{ student.name }}',{% endfor %}],
                    x: [{% for student in comparison_data %}{{ student.value }},{% endfor %}],
                    type: 'bar',
                    orientation: 'h',
                    marker: {
                        color: 'rgba(58, 130, 246, 0.7)'
                    }
                }
            ];
            
            const layout = {
                title: '{{ compare_by }} Comparison',
                xaxis: {
                    title: '{{ compare_by }}{% if compare_by == "Success Rate" %} (%){% endif %}'
                },
                margin: {
                    l: 250
                }
            };
            
            Plotly.newPlot(comparisonChart, chartData, layout);
            {% endif %}
        });
    </script>
</body>
</html>
